This is the main filtering
